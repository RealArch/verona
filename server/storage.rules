rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // ==========================================
    // FUNCIONES AUXILIARES
    // ==========================================
    
    // Verifica si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verifica si el usuario es admin (usando custom claims o documento en Firestore)
    function isAdmin() {
      return isAuthenticated() && 
             firestore.exists(/databases/(default)/documents/adminUsers/$(request.auth.uid));
    }
    
    // Verifica tamaño del archivo (máximo en bytes)
    function isValidSize(maxSize) {
      return request.resource.size <= maxSize;
    }
    
    // Verifica si es una imagen
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    // ==========================================
    // IMÁGENES DE PRODUCTOS
    // ==========================================
    match /img/products/{productId}/{fileName} {
      // Lectura: Pública (para que los clientes puedan ver productos)
      allow read: if true;
      
      // Escritura: Solo admin, máximo 5MB, solo imágenes
      allow write: if isAdmin() && 
                     isValidSize(5 * 1024 * 1024) && 
                     isImage();
      
      // Eliminación: Solo admin
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // IMÁGENES DE CATEGORÍAS
    // ==========================================
    match /img/categories/{categoryId}/{fileName} {
      // Lectura: Pública
      allow read: if true;
      
      // Escritura: Solo admin, máximo 3MB, solo imágenes
      allow write: if isAdmin() && 
                     isValidSize(3 * 1024 * 1024) && 
                     isImage();
      
      // Eliminación: Solo admin
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // IMÁGENES DE USUARIOS (Avatares)
    // ==========================================
    match /img/users/{userId}/{fileName} {
      // Lectura: Pública (avatares visibles)
      allow read: if true;
      
      // Escritura: Solo el propietario o admin, máximo 2MB, solo imágenes
      allow write: if (isAuthenticated() && request.auth.uid == userId || isAdmin()) && 
                     isValidSize(2 * 1024 * 1024) && 
                     isImage();
      
      // Eliminación: Solo el propietario o admin
      allow delete: if (isAuthenticated() && request.auth.uid == userId) || isAdmin();
    }
    
    // ==========================================
    // DOCUMENTOS Y ARCHIVOS TEMPORALES
    // ==========================================
    match /tmp/{userId}/{fileName} {
      // Archivos temporales: Solo el propietario, máximo 10MB
      allow read, write: if isAuthenticated() && 
                           request.auth.uid == userId && 
                           isValidSize(10 * 1024 * 1024);
      
      // Auto-delete después de 24 horas (configurar con lifecycle en Firebase Console)
    }
    
    // ==========================================
    // OTRAS RUTAS ADMINISTRATIVAS
    // ==========================================
    match /admin/{allPaths=**} {
      // Solo admin puede acceder
      allow read, write: if isAdmin();
    }
    
    // ==========================================
    // REGLA POR DEFECTO
    // ==========================================
    // Denegar acceso a cualquier otra ruta no especificada
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
