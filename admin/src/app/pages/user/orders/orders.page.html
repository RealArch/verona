<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>

    <ion-row class="w--full">
      <ion-col size="8" class="flex ">
        <ion-title>Ventas</ion-title>
      </ion-col>
      <ion-col size="4" class="py-0 flex justify-end items-center gap-2">
        <ion-searchbar animated="true" mode="ios" [(ngModel)]="searchQuery" (ionInput)="onSearchChange($event)"
          placeholder="Por nombre o email" [debounce]="500" class="searchbar"
          style="max-width: 320px; padding: 8px 16px;">
        </ion-searchbar>
        <!-- <ion-button fill="clear" size="small" (click)="refreshSearch()" class="refresh-search-btn">
          <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
        </ion-button> -->
      </ion-col>
    </ion-row>

  </ion-toolbar>
  <ion-toolbar color="light" class="px-5">
    <ion-grid fixed>

      <div class="flex gap-3 flex-wrap items-center">
        <!-- Filtro de Estado -->
        <ion-select mode="ios" #statusSelect [(ngModel)]="selectedStatus" (ionChange)="onStatusChange($event)"
          interface="popover" class="chip-select" shape="round">
          <ion-select-option *ngFor="let option of statusOptions" [value]="option.value">
            {{ option.label }}
          </ion-select-option>
          <div slot="label" class="flex items-center gap-2">
            <span class="text-gray-600">Estado:</span>
            <ion-icon name="chevron-down-outline" class="text-sm"></ion-icon>
          </div>
        </ion-select>

        <!-- Filtro de Método de Entrega -->
        <ion-select mode="ios" [(ngModel)]="selectedDeliveryMethod" (ionChange)="onDeliveryMethodChange($event)"
          interface="popover" class="chip-select" shape="round">
          <ion-select-option *ngFor="let option of deliveryMethodOptions" [value]="option.value">
            {{ option.label }}
          </ion-select-option>
          <div slot="label" class="flex items-center gap-2">
            <span class="text-gray-600">Entrega:</span>
            <ion-icon name="chevron-down-outline" class="text-sm"></ion-icon>
          </div>
        </ion-select>


        <!-- Filtro de Fecha Desde -->
        <ion-button fill="solid" shape="round" size="small" id="date-from-trigger" class="chip-button">
          <div class="flex items-center gap-2">
            <span class="text-gray-600">Desde:</span>
            <span *ngIf="dateFrom">{{ dateFrom | date:'dd/MM/yy' }}</span>
            <span *ngIf="!dateFrom">Todas</span>
            <ion-icon name="chevron-down-outline" class="text-sm"></ion-icon>
          </div>
        </ion-button>
        <ion-popover trigger="date-from-trigger" [keepContentsMounted]="true">
          <ng-template>
            <ion-datetime [value]="dateFrom" presentation="date" [max]="dateTo || undefined"
              (ionChange)="onDateFromChange($event)">
            </ion-datetime>
          </ng-template>
        </ion-popover>

        <!-- Filtro de Fecha Hasta -->
        <ion-button fill="solid" shape="round" size="small" id="date-to-trigger" class="chip-button">
          <div class="flex items-center gap-2">
            <span class="text-gray-600">Hasta:</span>
            <span *ngIf="dateTo">{{ dateTo | date:'dd/MM/yy' }}</span>
            <span *ngIf="!dateTo">Todas</span>
            <ion-icon name="chevron-down-outline" class="text-sm"></ion-icon>
          </div>
        </ion-button>
        <ion-popover trigger="date-to-trigger" [keepContentsMounted]="true">
          <ng-template>
            <ion-datetime [value]="dateTo" presentation="date" [min]="dateFrom || undefined"
              (ionChange)="onDateToChange($event)">
            </ion-datetime>
          </ng-template>
        </ion-popover>


        <!-- Botón de Reset -->
        <ion-button fill="clear" size="small" (click)="resetFilters()" class="reset-button" *ngIf="hasActiveFilters()">
          <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
    </ion-grid>

  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-grid fixed class="">



    <!-- Loading inicial -->
    <div *ngIf="isLoading && orders.length === 0" class="flex justify-center items-center py-20">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
    </div>

    <!-- Lista de órdenes -->
    <div *ngIf="!isLoading || orders.length > 0" class="space-y-4">
      <div *ngFor="let order of orders"
        class="bg-white rounded shadow-md hover:shadow-lg transition-all duration-200 cursor-pointer border border-gray-200 hover:border-primary"
        (click)="openOrderDetail(order)">

        <div class="px-4 py-0">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <!-- Order Info -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-3 mb-2">
                <h3 class="text-base font-semibold text-gray-800">
                  Pedido #{{ order?.id?.slice(-10)?.toUpperCase() || 'N/A' }}
                </h3>
                <ion-badge [color]="order?.status ? getStatusColor(order.status) : 'medium'" class="text-xs">
                  {{ order?.status ? getStatusLabel(order.status) : 'Desconocido' }}
                </ion-badge>
              </div>
              <div class="text-sm text-gray-600 space-y-1">
                <p class="flex items-center gap-2">
                  <ion-icon name="calendar-outline" class="text-base"></ion-icon>
                  {{ order?.createdAt ? formatDate(order.createdAt) : 'Fecha no disponible' }}
                </p>
                <p class="flex items-center gap-2">
                  <ion-icon name="receipt-outline" class="text-base"></ion-icon>
                  {{ order?.items?.length || 0 }} {{ (order?.items?.length || 0) === 1 ? 'artículo' : 'artículos' }}
                </p>
              </div>
            </div>

            <!-- Order Total -->
            <div class="text-right">
              <p class="text-xs text-gray-500 mb-1">Total</p>
              <p class="text-xl font-bold text-primary">{{ order?.totals?.total ? formatCurrency(order.totals.total) :
                '$0.00' }}</p>
            </div>

            <!-- Arrow Icon -->
            <div class="text-gray-400">
              <ion-icon name="chevron-forward-outline" class="text-xl"></ion-icon>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- No hay resultados -->
    <div *ngIf="!isLoading && orders.length === 0" class="text-center py-20">
      <ion-icon name="receipt-outline" class="text-gray-300 text-6xl mb-4"></ion-icon>
      <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay ventas</h3>
      <p class="text-gray-500">
        {{ searchQuery ? 'No se encontraron resultados para tu búsqueda' : 'Aún no tienes ninguna venta registrada' }}
      </p>
    </div>

    <!-- Infinite Scroll -->
    <ion-infinite-scroll threshold="100px" (ionInfinite)="loadMore($event)" [disabled]="!hasMore">
      <ion-infinite-scroll-content loadingSpinner="crescent" loadingText="Cargando más ventas...">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>

  </ion-grid>
</ion-content>
